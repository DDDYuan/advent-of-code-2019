import utils

testDonut = '''         A           
         A           
  #######.#########  
  #######.........#  
  #######.#######.#  
  #######.#######.#  
  #######.#######.#  
  #####  B    ###.#  
BC...##  C    ###.#  
  ##.##       ###.#  
  ##...DE  F  ###.#  
  #####    G  ###.#  
  #########.#####.#  
DE..#######...###.#  
  #.#########.###.#  
FG..#########.....#  
  ###########.#####  
             Z       
             Z     '''

testDonut2 = '''                   A               
                   A               
  #################.#############  
  #.#...#...................#.#.#  
  #.#.#.###.###.###.#########.#.#  
  #.#.#.......#...#.....#.#.#...#  
  #.#########.###.#####.#.#.###.#  
  #.............#.#.....#.......#  
  ###.###########.###.#####.#.#.#  
  #.....#        A   C    #.#.#.#  
  #######        S   P    #####.#  
  #.#...#                 #......VT
  #.#.#.#                 #.#####  
  #...#.#               YN....#.#  
  #.###.#                 #####.#  
DI....#.#                 #.....#  
  #####.#                 #.###.#  
ZZ......#               QG....#..AS
  ###.###                 #######  
JO..#.#.#                 #.....#  
  #.#.#.#                 ###.#.#  
  #...#..DI             BU....#..LF
  #####.#                 #.#####  
YN......#               VT..#....QG
  #.###.#                 #.###.#  
  #.#...#                 #.....#  
  ###.###    J L     J    #.#.###  
  #.....#    O F     P    #.#...#  
  #.###.#####.#.#####.#####.###.#  
  #...#.#.#...#.....#.....#.#...#  
  #.#####.###.###.#.#.#########.#  
  #...#.#.....#...#.#.#.#.....#.#  
  #.###.#####.###.###.#.#.#######  
  #.#.........#...#.............#  
  #########.###.###.#############  
           B   J   C               
           U   P   P               '''

donut = '''                                         S       U A   R     G     V       B       L                                       
                                         X       Y A   U     T     M       Y       G                                       
  #######################################.#######.#.###.#####.#####.#######.#######.#####################################  
  #...#.#.#...................#...#.#...#...#.#.#.#.....#...#...#...#.#.......#.....#...#...#.....#.........#.....#...#.#  
  ###.#.#.###.###.#####.###.#####.#.#.#.#.###.#.#.#.#####.#.###.#.###.#######.#.###.#.#####.###.###.#####.#.#.#####.#.#.#  
  #.............#.#.....#.............#...#...#.#.#.#...#.#.#...#.....#...#.#.#...#.......#.........#...#.#.#...#.#.#.#.#  
  ###.#####.#.#.#.#.#.#####.#####.#.#######.#.###.#.#.#.#.#.#.###.#.#.###.#.#.###.#####.###.#########.#########.#.###.#.#  
  #...#.....#.#.#.#.#.#.....#...#.#.....#.#.#.....#...#.#.#.#...#.#.#...#.#...#.......#.#.........#.....#.....#...#.....#  
  #.#####.###.#.###############.###.#####.#.###########.#.#.#.###.###.###.#.#####.#.#.###.#####.###.#########.#.#.#####.#  
  #.#.#.....#.#.#.........................#.......#.#...#.#.....#.#.#...#.....#...#.#...#...#...........#.......#...#.#.#  
  ###.#.#.###########.###########.#######.###.#.#.#.#.###.#####.###.#.#####.###.#########.#######.###########.###.###.#.#  
  #.....#.#.#...#...#.#.#.#.#.#...#.#.....#...#.#.#...#...#...#.#.......#.....#.#.#.#.#.#.......#.#...#...#...#.#.#.#.#.#  
  #.###.###.#.#####.###.#.#.#.#.###.#.#.###.#####.#.#.###.#.#########.#.#.###.#.#.#.#.#.#.#.#######.#####.#.#.#.#.#.#.#.#  
  #.#.....#.#.............#.#.#.#.....#.#.#.#.....#.#.#.#...#.....#.#.#.#.#...#.#.#.......#.#.....#.#.#...#.#.#.#.#...#.#  
  #####.###.#############.#.#.#####.#.###.###.###.###.#.#.#.#####.#.#.#######.#.#.#.###.#.#.###.###.#.###.###.#.###.###.#  
  #.#.#.#.#.#.....#.......#.......#.#...#.....#.#.#...#.#.#...#.....#.#.#.#...#.......#.#.#.#.....#...#...#...#.....#...#  
  #.#.###.#.#.#.#.#####.#.###.###.###.#####.#.#.#.###.#.#.###.###.###.#.#.#.#.###.###########.#####.#.###.###.#.#.#####.#  
  #.....#...#.#.#...#.#.#...#...#.....#.....#.#.#.#...#.....#.#.........#...#.#.........#.....#...#.#...#.......#.#.....#  
  #####.#.#####.#.#.#.#.#.#######.###.###.#.###.###.#.#.#.#####.#####.#######.#.#########.#######.#.#####.#############.#  
  #.#.#...#...#.#.#.#.#.#.........#...#...#...#.....#.#.#.....#.#.#.....#...#.#.....#.........#.#.#.....#.....#.#.#.....#  
  #.#.###.#.#####.###.###.#####.###.#########.#.###.#######.#####.###.#####.#.#.#####.#.#######.#.#.#.###.#.#.#.#.###.#.#  
  #.#.#...#.....#...#.....#.#.....#...#.#...#.#.#...#.#.....#...#.......#.#...#...#...#.#.#.#.......#.#...#.#.#.#...#.#.#  
  #.#.###.#.#####.#####.#.#.#######.###.#.###.###.#.#.###.###.###.#.#.###.#.###.#####.###.#.#.#####.###.#######.#.#####.#  
  #.....#.#...#.#...#.#.#.#.#.....#...#.........#.#...#.........#.#.#.....#.#.#.#...#.#.#.........#.#.#.#...#...#...#.#.#  
  ###.###.#.###.#.###.#.#.#.#####.#.###.###.###.#####.#######.#######.#####.#.#.#.###.#.#.###.#######.#.#.#.#.#####.#.#.#  
  #...#.....#.........#.#.#.#.........#.#.#.#.#.#.#.....#.....#.......#.#.....#...........#.....#.#.#...#.#.#...#...#.#.#  
  ###.#.###.#####.#########.###.###.#####.#.#.###.#.#.###.#########.#.#.#####.###.###.###########.#.###.#.###.#####.#.#.#  
  #.#...#.#...#.#.#...#.#.#.#...#.....#.....#.#.....#.#...#...#.....#.#.......#.....#.#.#.#.#...#.....#...#.....#.....#.#  
  #.#####.#.###.#.#.###.#.#.#######.#####.#.#.#####.###.#.#.#.###.#####.#########.###.#.#.#.#.###.#####.###.#########.#.#  
  #.#...#.......#.#.#.....#...........#...#.#.#.#.....#.#...#...#.....#.........#.#.....#.....#.....#...........#.......#  
  #.#.#######.###.#.###.#.#########.#######.#.#.###.#.#####.#.#.#####.#######.#.###.#######.#.###.#########.#.#####.#.###  
  #...#...#.#.#.#...#...#.#...#.#.........#.....#...#...#...#.#.#.....#.......#...#.....#...#.#.#...#.#.#...#.#...#.#.#.#  
  ###.###.#.#.#.#.#####.#####.#.#######.###.###########.#######.#.#####.#############.#######.#.#.###.#.###.#####.###.#.#  
  #.#.#.#...#...#.#...#.#...#...#      E   X           K       R X     V             W    #.........#...#...#...#.#...#.#  
  #.#.#.#.#####.#.#.###.#.###.###      N   I           H       F B     M             D    #.###.#######.#.#.###.#.#.###.#  
  #.....#.....#...........#.....#                                                         #.#.....#.....#.#.#.#.#.......#  
  #.###.#.###.#.#####.#.#.#.###.#                                                         #####.#######.#.###.#.###.#.###  
  #.#...#...#...#.....#.#.#...#..UO                                                     QA..#.............#.#.......#.#..MB
  #.#.#####.###.###.#.#.#.#.#.###                                                         #.#.#.#.###.###.#.#.###.#####.#  
HV..#.....#.#.....#.#.#.#.#.#...#                                                         #...#.#.#.....#...#.#...#.....#  
  #######.#.#.#####.#.###.#####.#                                                         #########.#.###.#.#.#.#####.#.#  
  #.#...#...#.#.#...#.#.#.......#                                                         #.....#...#.#.#.#...#.#.....#.#  
  #.#.#########.#######.#########                                                         ###.#########.#.#.###.#.#.#.#.#  
  #.......#...#.......#.....#...#                                                         #...#.......#.#.#...#...#.#.#..ZZ
  #.#.#.#.#.#.#.#.###.#.###.#.#.#                                                         ###.#####.###.#.#.###.#.#######  
  #.#.#.#...#.#.#.#...#.#.....#.#                                                         #...#.#.#.#...#.#.#...#.#.#.#..YX
  #.#####.#.#.#.#.#.###.#######.#                                                         #.#.#.#.#.#.#.#.#########.#.#.#  
  #.....#.#.#...#.#.#...#.#.....#                                                       GT..#.....#...#.#...#.....#.....#  
  #.#.#############.###.#.###.###                                                         #.#.#.#.#.###.#######.###.#.#.#  
XI..#.#.#...#.#...#.......#......AO                                                       #.#.#.#...#...#.#.#...#.#.#.#.#  
  #.#.#.###.#.###.#######.###.#.#                                                         ###.#####.#.###.#.###.#.#.#####  
  #.#.#.......#.........#.#.#.#.#                                                         #...#.#...#.................#.#  
  #####.###.###.#####.#.###.#.###                                                         ###.#.###.#.###.#.###.#######.#  
WD......#...........#.#.....#.#.#                                                         #.#.#.....#.#.#.#.#.#.#...#....AO
  #.###.#####.#.###########.###.#                                                         #.#########.#.###.#.###.#.#.###  
  #.#.....#...#...#.........#...#                                                         #...#.........#.#.#.#...#.#...#  
  #.#########.#.#######.#####.#.#                                                         #.#############.###.#.#.#.#.#.#  
  #...#...#.#.#.#...#.........#..MB                                                     PI..#...#.#.#.#...#.....#.#.#.#.#  
  #######.#.#.#####.#.###.#.#.###                                                         #.###.#.#.#.#.#####.#.###.###.#  
  #...#.....#.#.#.#.#...#.#.#.#..UY                                                       #...................#.#.......#  
  #.###.#######.#.#.###########.#                                                         #######.#######################  
ZY....#...#.....#.#.#.#..........HV                                                     RU......#.#...............#...#..PI
  #.#.#.#####.#.#.#.#.#####.#.###                                                         #####.###.###.###.###.#.#.#.#.#  
  #.#.....#...#.........#...#...#                                                         #...#.#...#.....#.#.#.#...#...#  
  #.###.#####.###.###.###.###.#.#                                                         #.###.#.###.###.#.#.#.#.#######  
OQ..#.#.......#.#...#.......#.#.#                                                         #.#...#...#...#.#...#.#.....#.#  
  ###.#########.###############.#                                                         ###.###.#####.#########.#####.#  
  #...............#.#.......#...#                                                         #.......#...#...#.#...#.#.#...#  
  #.###.#####.#####.#.#####.#####                                                         ###########.#####.###.###.#.###  
  #.#.#.....#...#.#.....#.....#.#                                                         #.............#.#...........#.#  
  ###.###.###.###.#####.#.#####.#                                                         #.###.###.#.###.###.#.#####.#.#  
  #.....#.#...#.#.#.....#.......#                                                       OQ..#.....#.#.#.#.....#.....#.#..WA
  #.###.#.#.###.#.#.#########.###                                                         #.#.#########.#####.#######.#.#  
UO..#.#...#.............#.#.#....SX                                                       #.#.....#.#...#...#...#.....#.#  
  ###.###############.###.#.#####                                                         ###.###.#.###.###.#.#######.#.#  
  #.......#.........#.#...#.....#                                                         #.#.#.#.............#.#.......#  
  #.#.#.#.#.#.###.#.###.#.#.###.#                                                         #.###.#####.#.###.#.#.#######.#  
  #.#.#.#...#...#.#.....#.....#..BY                                                     WA....#.....#.#.#...#...#...#.#.#  
  #.###############.#######.###.#                                                         ###.#.###.###.#########.###.###  
RF....#.#.#...#.....#.#.#...#.#.#                                                         #...#.#...#.......#...#.#.#.#.#  
  #####.#.###.#######.#.#####.###                                                         #.###.###.###.#####.###.#.#.#.#  
  #.#.#.#.................#.#....TR                                                       #.....#.....#...#.#.....#.#...#  
  #.#.#.#.#.#.#.###.#.###.#.###.#                                                         #.###.###.#######.#.#.###.#.###  
XB....#...#.#.#.#...#.#.........#                                                         #...#.#.#...........#..........KH
  ###.#.#.#.#.#####.#####.#.#.###                                                         #.#####.#.###.#.#.#.###.#.###.#  
  #...#.#.#.#.#.....#.#...#.#...#                                                         #...#.......#.#.#.#.#.#.#.#...#  
  ###.#.#####.###.#.#.#.#.#.#.###                                                         ###.###.#####.#.###.#.#.#####.#  
  #.......#.....#.#...#.#.#.#...#                                                         #...#.....#.#.#...#.#.......#.#  
  ###.#.#####.#.###.#.#####.###.#            Z       M   Y           M       P   L        #.#.#.#.###.#.#.###.#.#.#######  
  #...#.#...#.#.#...#...#...#...#            Y       W   X           D       S   G        #.#.#.#.#.....#...#.#.#.......#  
  ###.###.#########.#########################.#######.###.###########.#######.###.###########.###.#.#.#.###.#####.###.###  
  #.........#...#.......#.#.......#.....#...#.#.#...#.#.........#.......#.#.#.#...#.......#.#...#.#.#.#...#.....#...#...#  
  #.###.#####.###.#.#.###.###.#########.#.#.#.#.#.#.#.#.#.#.###.###.#.###.#.#.#.#####.#.###.#.#####.###.###.#####.#.#.###  
  #.#.........#...#.#.#.........#.#.#.....#...#...#...#.#.#...#.#.#.#...#.#...#.....#.#.....#...#.#.#.#.#.#.....#.#.#...#  
  #####.#.###.#.###.#########.#.#.#.#.###.#####.#.#####.#########.###.###.###.###.###.#.#######.#.###.#.#.###.#####.#.###  
  #.#...#...#.#.#.....#.#.#...#.#.....#.....#.#.#.#...........#.....#.....#.#.#...#.#.#.#...#.#.#...........#...#...#...#  
  #.#.#.#.#.###########.#.#.#.###.#.#######.#.#.#######.#.#######.###.#.###.#.#.###.#.###.###.###.###.#####.#.#.###.###.#  
  #.#.#.#.#.........#.....#.#.#.#.#.#.........#...#.....#.#.#...#.#...#.#.#...#.......#.........#...#...#...#.#...#.#...#  
  #.#.###.#######.#######.###.#.#.#######.#######.#######.#.#.#.#.#.#####.#.###.###.#.#.###.#########.###.#.#.#####.###.#  
  #...#.........#.#...#.........#.#.#.....#.#.#.....#.......#.#.#.....#.......#...#.#.....#...#.#...#.#.#.#.#...#.....#.#  
  ###.#.#########.#.#######.#.#.###.###.#.#.#.#.###.#.#.#######.#.#####.#.#.#.#######.###.#.###.#.###.#.###.#.###.#.###.#  
  #.#.#.#...#...#.#.#.#.#...#.#.........#.#.....#.#.#.#...#.#.........#.#.#.#.#.........#.#.#...#.#.......#.#...#.#.#...#  
  #.#.###.#####.###.#.#.###.#####.#####.###.###.#.#####.###.#.#.#####.#######.#####.###########.#.###.#######.#####.###.#  
  #.....#.........#.........#.....#.......#.#.#.....#.#...#.#.#...#.#...#.....#.......#.......#.....#...#.......#.....#.#  
  #####.#.###.###########.#####.###.###.###.#.#.#####.#.###.#.#.###.#.#######.#####.###.#.#.###.###.#.#####.#.#.###.#.###  
  #.........#...#.#.......#.#...#...#.....#.#...#...........#.#...#.#.#.#.......#.#.....#.#.#.#...#.#.#...#.#.#...#.#...#  
  #.###.#########.#.#####.#.###.#.#####.###.#.#.#######.#######.#.#.###.###.###.#.#.#########.#.#####.#.#####.#####.###.#  
  #...#.......#.....#.#...#.....#.#.......#.#.#...#.....#.......#.#.......#...#.#.#.#.#...........#.......#.#...#...#...#  
  #.#.###.###.#.#####.###########.#####.#.#####.#######.###.###.#########.#.#####.#.#.#.#.###########.#####.#.#.#.#.#.###  
  #.#.#...#...#.#.........#.#...#.#.#.#.#.#...........#...#.#.#...#...........#.........#.....#...#.........#.#.#.#.#...#  
  #.#.#.###.#############.#.#.#####.#.#.###.#.#.#########.###.#.#############.#.#####.###.#####.###.#.#.###.###.#######.#  
  #.#.#...#.#.#.#.#.....#.#.#.#...#.......#.#.#.#.#.....#.....#...#.#.#...#...#...#...#.#.#.#.....#.#.#...#.#.........#.#  
  ###.#.#.###.#.#.#####.#.#.#.###.#####.#.#####.#.#.###.#####.#.###.#.#.###.#.###.#####.###.#.#########.#.###.###.###.#.#  
  #.#.#.#.#.....#.#.....................#...#.....#.#.#.......#...#...#...#.#.#.......#...............#.#.#.....#...#.#.#  
  #.#.#########.#.#.#.#.###.#####.#.###.#######.#####.###.#####.#####.#.#.#.#.#.#######.###.#.###.###.###########.#####.#  
  #.....#...#.......#.#.#.....#.#.#.#.....#.#.#.#.....#.#.#.#.#...#.....#...#.#.........#.#.#.#...#.....#.......#...#...#  
  #.#######.#.#####.###.#######.#######.###.#.#.###.###.#.#.#.###.#####.###.###.#########.#.###.#.#####.#.#######.#.###.#  
  #.#...#...#.#.....#...#.............#.#.....#.......#.....#.#.......#.#.#.#.............#...#.#...#.......#.#.#.#...#.#  
  #.#.#.#.#.#.#####.###.#####.#######.#.#.#.#########.#.#####.#######.#.#.#####.###############.#.#.#.###.###.#.#####.###  
  #.#.#...#.....#...#...#.....#...........#.....#.....#.......#.......#...#...................#.#.#.#...#...........#...#  
  ###########################################.###.#########.#######.#####.#########.#####################################  
                                             M   T         P       Q     M         E                                       
                                             W   R         S       A     D         N                                       '''


def getNodeInfo(x, y, grid):
    firstCharacter = grid[y][x]
    if x + 1 < len(grid[y]) and 'A' <= grid[y][x + 1] <= 'Z':
        nextCharacter = grid[y][x + 1]
        if x - 1 >= 0 and grid[y][x - 1] == '.':
            position = (x - 1, y)
            portal = (x, y)
        else:
            position = (x + 2, y)
            portal = (x + 1, y)
    elif y + 1 < len(grid) and 'A' <= grid[y + 1][x] <= 'Z':
        nextCharacter = grid[y + 1][x]
        if y - 1 >= 0 and grid[y - 1][x] == '.':
            position = (x, y - 1)
            portal = (x, y)
        else:
            position = (x, y + 2)
            portal = (x, y + 1)
    else:
        return None
    return firstCharacter + nextCharacter, position, portal


def parseGrid(grid):
    nodes = []
    for y in range(len(grid)):
        for x in range(len(grid[y])):
            current = grid[y][x]
            if 'A' <= current <= 'Z':
                node = getNodeInfo(x, y, grid)
                if node is not None:
                    nodes.append(node)
    return nodes


def findPortalPair(portals, portalName):
    return [(position, portalPosition) for (name, position, portalPosition) in portals if name == portalName]


def parsePortals(portals):
    link = dict()
    start = None
    end = None

    for portal in portals:
        name, position, teleportPosition = portal
        if name == 'AA':
            start = position
        elif name == 'ZZ':
            end = position
        else:
            [(position1, portal1), (position2, portal2)] = findPortalPair(portals, name)
            link[portal1] = position2
            link[portal2] = position1
    return start, end, link


def getMinSteps(grid, start, end, portals):
    frontier = [(start, 0)]
    reached = []

    def notInFrontier(fx, fy):
        for (cx, cy), d in frontier:
            if (cx, cy) == (fx, fy):
                return False
        return True

    while len(frontier) > 0:
        (x, y), distance = frontier.pop(0)
        if (x, y) == end:
            return distance
        else:
            reached.append((x, y))
            for (nextX, nextY) in [(x - 1, y), (x + 1, y), (x, y - 1), (x, y + 1)]:
                if 0 <= nextY < len(grid) and 0 <= nextX < len(grid[nextY]):
                    nodeName = grid[nextY][nextX]
                    if nodeName == '.' or (nextX, nextY) in portals:
                        (frontierX, frontierY) = (nextX, nextY) if nodeName == '.' else portals.get((nextX, nextY))
                        if (frontierX, frontierY) not in reached and notInFrontier(frontierX, frontierY):
                            frontier.append(((frontierX, frontierY), distance + 1))


if __name__ == '__main__':
    raw = utils.parseGraph(donut)
    s, e, p = parsePortals(parseGrid(raw))
    print(getMinSteps(raw, s, e, p))
